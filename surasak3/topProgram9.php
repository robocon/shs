<?php
// include '../includes/functions.php';

$ncr_items = array(
    1 => array(
        'title' => 'ความปลอดภัย / ตก/ หกล้ม',
        'items' => array(
            'topic1_1' => 'ล้ม', 
            'topic1_2' => 'พบว่านอนอยู่บนพื้น', 
            'topic1_3' => 'ตกจากเตียง/เก้าอื้/โต๊ะ', 
            'topic1_4' => 'เครื่องรัดตรึงหลุด', 
            'topic1_5' => 'ปีนข้ามไม้กั้นเตียง', 
            'topic1_6' => 'พลัดตกระหว่างการเคลื่อนย้าย', 
            'topic1_7' => 'อื่นๆ'
        )
    ),
    2 => array(
        'title' => 'การติดต่อสื่อสาร',
        'items' => array(
            'topic2_1' => 'ไม่มีรายงานผล Lab/Film X-ray ด่วน หรือ ผิดปกติ', 
            'topic2_2' => 'ไม่มีรายงานแพทย์/แพทย์ไม่ตอบ', 
            'topic2_3' => 'ปฏิบัติไม่ถูกต้องตามคำสั่ง', 
            'topic2_4' => 'เวชระเบียนไม่สมบูรณ์', 
            'topic2_5' => 'ใบยินยอมไม่ตรงกับหัตถการ', 
            'topic2_6' => 'ทำหัตถการโดยไม่มีใบยินยอม', 
            'topic2_7' => 'อื่นๆ'
        )
    ),
    3 => array(
        'title' => 'การติดต่อสื่อสาร',
        'items' => array(
            'topic3_1' => 'ผิดคน',
            'topic3_2' => 'ภาวะแทรกซ้อนจากการให้เลือด',
            'topic3_3' => 'แพ้เลือด',
            'topic3_4' => 'อื่นๆ'
        )
    ),
    4 => array(
        'title' => 'เครื่องมือ',
        'items' => array(
            'topic4_1' => 'ผู้ป่วยถูกลวก / ไหม้',
            'topic4_2' => 'ตกใส่ผู้ป่วย',
            'topic4_3' => 'ไม่ทำงาน / ทำงานผิดปกติ',
            'topic4_4' => 'ไม่มีเครื่องมือ ใช้',
            'topic4_5' => 'ลิฟท์ไม่ทำงาน',
            'topic4_6' => 'อื่นๆ'
        )
    ),
    5 => array(
        'title' => 'การวินิจฉัย / รักษา',
        'items' => array(
            'topic5_1' => 'รับ Admit ซ้ำโดยโรคเดิมใน 7 วัน',
            'topic5_2' => 'ไม่สามารถวินิจฉัยโรคที่ต้อง admit หรือมา ER ซ้ำ',
            'topic5_3' => 'อ่านผลเอ็กซ์เรย์ผิด',
            'topic5_4' => 'ล่าช้าในการรักษาผู้ป่วยที่ทรุดลง',
            'topic5_5' => 'ภาวะแทรกซ้อนจากหัตถการ',
            'topic5_6' => 'ทำ Diag Proc ซ้ำโดยไม่มีแผน',
            'topic5_7' => 'การเฝ้าระวังไม่เพียงพอ',
            'topic5_8' => 'ใส่ Cath / Tube / Drain ไม่ถูก',
            'topic5_9' => 'ดูแล Cath / Tube / Drain',
            'topic5_10' => 'ย้ายผู้ป่วยเข้า ICU โดยไม่มีแผน',
            'topic5_11' => 'อื่นๆ'
        )
    ),
    6 => array(
        'title' => 'การคลอด',
        'items' => array(
            'topic6_1' => 'ไม่พบ Fetal distress ทันท่วงที',
            'topic6_2' => 'ผ่าตัดคลอดช้าเกินไป',
            'topic6_3' => 'ภาวะแทรกซ้อนจากการคลอด',
            'topic6_4' => 'บาดเจ็บจากการคลอด',
            'topic6_5' => 'อื่นๆ'
        )
    ),
    7 => array(
        'title' => 'การผ่าตัด / วิสัญญี',
        'items' => array(
            'topic7_1' => 'ภาวะแทรกซ้อนทางวิสัญญี',
            'topic7_2' => 'ผ่าตัดผิดคน / ผิดข้าง / ผิดตำแหน่ง',
            'topic7_3' => 'ตัดอวัยวะออกโดยไม่ได้วางแผน',
            'topic7_4' => 'เย็บซ่อมอวัยวะที่บาดเจ็บ',
            'topic7_5' => 'ทิ้งเครื่องมือ / ก๊อส ไว้ในผู้ป่วย',
            'topic7_6' => 'กลับมาผ่าตัดซ้ำ',
            'topic7_7' => 'อื่นๆ'
        )
    ),
    8 => array(
        'title' => 'อื่น ๆ',
        'items' => array(
            'topic8_1' => 'ผู้ป่วย / ญาติ ไม่พึงพอใจ',
            'topic8_2' => 'ไม่สมัครใจอยู่ รพ.',
            'topic8_3' => 'มีการทำร้ายร่างกาย ผู้ป่วย / ญาติ / เจ้าหน้าที่',
            'topic8_4' => 'ผู้ป่วยพยายามฆ่าตัวตาย / ทำร้ายร่างกายตัวเอง',
            'topic8_5' => 'โจรกรรม / ลักขโมย',
            'topic8_6' => 'การคุกคาม / ข่มขู่',
            'topic8_7' => 'สิ่งแวดล้อมเป็นอันตราย / ปนเปื้อน',
            'topic8_8' => 'อุบัติเหตุไฟไหม้',
            'topic8_9' => 'จนท. บาดเจ็บจากการทำงาน ',
            'topic8_10' => 'ไม่ได้เรียกเก็บค่าใช้จ่าย',
            'topic8_11' => 'อื่นๆ'
        )
    )
);

$con = mysql_connect('localhost','root','1234');
mysql_select_db('dbconform', $con);

$year_select = ( !empty($_POST['year_select']) ) ? $_POST['year_select'] : date('Y')+543 ;

?>
<h3>Top 10 ความเสี่ยงโปรแกรม9</h3>
<fieldset style="width: 30%;">
    <legend>เลือกการค้นหา</legend>
    <form action="topProgram9.php" method="post">
        <div>
            ปี <select name="year_select" id="">
                <?php
                foreach ( range(2004, date('Y')) as $key => $value) {
                    $year_th = $value + 543;

                    $selected = ( $year_th == $year_select ) ? 'selected="selected"' : '' ;
                    ?>
                    <option value="<?=$year_th;?>" <?=$selected;?>><?=$year_th;?></option>
                    <?php
                }
                ?>
            </select>
        </div>
        <div>
            <button type="submit">แสดงผล</button>
            <input type="hidden" name="show" value="1">
        </div>
    </form>
</fieldset>
<?php

$show = $_POST['show'];
if( !empty($show) && $show === '1' ){

    $year_start = $_POST['year_select'];
    $year_end = $year_start + 1;

    $sql = "SELECT SUM(`topic1_1`) AS `topic1_1`,SUM(`topic1_2`) AS `topic1_2`,SUM(`topic1_3`) AS `topic1_3`,SUM(`topic1_4`) AS `topic1_4`,SUM(`topic1_5`) AS `topic1_5`,SUM(`topic1_6`) AS `topic1_6`,SUM(`topic1_7`) AS `topic1_7`,
    SUM(`topic2_1`) AS `topic2_1`,SUM(`topic2_2`) AS `topic2_2`,SUM(`topic2_3`) AS `topic2_3`,SUM(`topic2_4`) AS `topic2_4`,SUM(`topic2_5`) AS `topic2_5`,SUM(`topic2_6`) AS `topic2_6`,COUNT(`topic2_7`) AS `topic2_7`,
    SUM(`topic3_1`) AS `topic3_1`,SUM(`topic3_2`) AS `topic3_2`,SUM(`topic3_3`) AS `topic3_3`,
    SUM(`topic4_1`) AS `topic4_1`,SUM(`topic4_2`) AS `topic4_2`,SUM(`topic4_3`) AS `topic4_3`,SUM(`topic4_4`) AS `topic4_4`,SUM(`topic4_5`) AS `topic4_5`,SUM(`topic4_6`) AS `topic4_6`,
    SUM(`topic5_1`) AS `topic5_1`,SUM(`topic5_2`) AS `topic5_2`,SUM(`topic5_3`) AS `topic5_3`,SUM(`topic5_4`) AS `topic5_4`,SUM(`topic5_5`) AS `topic5_5`,SUM(`topic5_6`) AS `topic5_6`,SUM(`topic5_7`) AS `topic5_7`,SUM(`topic5_8`) AS `topic5_8`,SUM(`topic5_9`) AS `topic5_9`,SUM(`topic5_10`) AS `topic5_10`,SUM(`topic5_11`) AS `topic5_11`,
    SUM(`topic6_1`) AS `topic6_1`,SUM(`topic6_2`) AS `topic6_2`,SUM(`topic6_3`) AS `topic6_3`,SUM(`topic6_4`) AS `topic6_4`,SUM(`topic6_5`) AS `topic6_5`,
    SUM(`topic7_1`) AS `topic7_1`,SUM(`topic7_2`) AS `topic7_2`,SUM(`topic7_3`) AS `topic7_3`,SUM(`topic7_4`) AS `topic7_4`,SUM(`topic7_5`) AS `topic7_5`,SUM(`topic7_6`) AS `topic7_6`,SUM(`topic7_7`) AS `topic7_7`,
    SUM(`topic8_1`) AS `topic8_1`,SUM(`topic8_2`) AS `topic8_2`,SUM(`topic8_3`) AS `topic8_3`,SUM(`topic8_4`) AS `topic8_4`,SUM(`topic8_5`) AS `topic8_5`,SUM(`topic8_6`) AS `topic8_6`,SUM(`topic8_7`) AS `topic8_7`,SUM(`topic8_8`) AS `topic8_8`,SUM(`topic8_9`) AS `topic8_9`,SUM(`topic8_10`) AS `topic8_10`,SUM(`topic8_11`) AS `topic8_11` 
    FROM `ncr2556` 
    WHERE `nonconf_date` LIKE '$year_start%' 
    GROUP BY `type`";
    $q = mysql_query($sql) or die ( mysql_error() );
    $t1_1 = 0;

    $items = array();
    foreach ( mysql_fetch_assoc($q) as $key => $value) {
        $items[$key] = (int) $value;
    }

    arsort($items);

    $i = 0;

    ?>
    <h3>Top 10 ความเสี่ยงโปรแกรม9 ปี <?=$year_start;?></h3>
    <table border="1" cellpadding="2" cellspacing="0" style="border-collapse: collapse; border-color: #000;">
        <thead>
            <tr>
                <th>ลำดับ</th>
                <th>หัวข้อ</th>
                <th>เรื่อง</th>
                <th>จำนวน</th>
            </tr>
        </thead>
        <tbody>
        <?php
        $i = 0;
        foreach ($items as $key => $value) {
            ++$i;
            if( $i > 10 ){
                continue;
            }

            $match = preg_match('/topic(\d)/', $key, $matchs);
            if( $match > 0 ){
                $main_key = $matchs['1'];
            }

            $topic = $ncr_items[$main_key]['title'];
            $detail = $ncr_items[$main_key]['items'][$key];
            ?>
            <tr>
                <td align="right"><?=$i;?></td>
                <td><?=$topic;?></td>
                <td><?=$detail.' '.$key;?></td>
                <td align="right"><a href="NCR2556/detail_report_event.php?y=<?=$year_start;?>&topicdetail=<?=$key;?>" target="_blank"><?=$value;?></a></td>
            </tr>
            <?php
        }
        ?>
        </tbody>
    </table>
    <?php

}


// var_dump($items);


/*
$sql = "SELECT `clinic`, COUNT(`clinic`) AS `row` 
FROM `ncr2556` 
WHERE `nonconf_date` >= '2558-10-01' AND `nonconf_date` <= '2559-09-30' 
AND `clinic` != '' 
GROUP BY `clinic`;";
$q = mysql_query($sql) or die ( mysql_error() );
while ( $item = mysql_fetch_assoc($q) ) {
    var_dump($item);
}
*/